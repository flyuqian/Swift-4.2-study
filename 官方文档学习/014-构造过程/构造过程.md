#### 构造过程

---

*构造过程* 就是使用类，结构体或枚举实例的准备过程，这个过程包含了设置实例每个存储属性的初始值并在实例使用之前执行全部所需的其他设置或初始化。

通过定义*构造器*来实现构造过程，这更像调用创建某一类型实例的特殊方法。和 Objective-C 的构造器不同，Swift 的构造器不用返回值。它们主要的作用就是确保在第一次使用前某类型的实例都能正确的初始化。

- 设置存储属性的初始值

  - 类和结构体在创建实例时， 必须为它们所有的存储属性设置适当的初始值，存储属性不能出于未知状态
  - 可以在构造器中设置初始值，或者定义属性时设置默认值
  - 在构造器中为存储属性设置默认值时，不会调用任何属性观察器

- 构造器

  - init
  - 对于类的实例来说，常量属性只能在定义常量属性类的构造器中修改。不能在派生类中修改。
  - 默认构造器
    - Swift 为 属性均有默认值 和 没有构造器的结构体或类提供了一个默认构造器
  - 结构体的成员构造器
    - 如果结构体没有任何自定义的构造器，那么结构体会自动接收一个 成员构造器
    - 不同于默认构造器，结构体成员没有值，也会接收成员构造器
  - 值类型的构造器代理
    - 构造器可以调用其他构造器来执行实例的部分构造过程， 这个过程称之为 构造器代理
    - 如果值类型定义了自定义构造器，将无法访问默认构造器
    - 若想  自定义类型 可以使用  默认构造器、成员构造器、自定义构造器初始化， 自定义构造器需写在extension中

- 类的继承和构造过程

  - 类的所有存储属性（包括任何从父类继承来的属性）， 必须在构造过程期间赋值，，Swift给类定义了 指定构造器和便利构造器    确保所有存储属性都能接收到初始值

  - 指定构造器  初始化该类引入的所有属性，并调用合适的父类构造器以继承父类链上的构造过程 - 每个类至少有一个指定构造器

  - 便利构造器  

    - 可以调用指定构造器，并为指定构造器一些参数设置默认值
    - 可以为特殊用例类或输入类型类创建实例
    - 只在需要时提供，用于节省时间、清晰构造过程
    - 便利构造器 需使用 convenience 关键字

  - 累的构造代理

    - 指定构造器 必须调用其父类的指定构造器

    - 便利构造器 必须调用同意类中的其他构造器

    - 便利构造器 最后必须调用指定构造器

      ​

  - 两段式构造器过程

    - 一： 为类引入的每个存储属性赋一个初始值
    - 二： 在实例被认为可使用前，进一步定制存储属性
    - 编译器 提供安全检查
      - 引入的所有属性，在向上代理父类构造器之前完成初始化
      - 构造器必须在继承属性赋值前，向上代理父类构造器
      - 便利构造器，必须在任何属性赋值前代理另一个构造器
      - 构造器在第一阶段构造过程完成前，不能调用任何实例方法，不能读取任何属性值，不能引用

```
阶段 1
- 在类中调用指定或便利构造器。
- 对一个新实例分配内存，但内存没还没有初始化。
- 指定构造器确认其所属类的所有存储属性都有值。现在那些存储属性的内存初始化完成。
- 指定构造器移交给父类构造器以为其存储属性执行相同的任务。
- 这个过程沿着类的继承链持续向上，直到到达继承链的顶端。
- 一旦到达链的顶端，并且链中最后的类确保其所有存储属性都有值，则认为实例的内存已经完全初始化，至此阶段 1 完成。
阶段2
- 从链顶端往下，链中每个指定构造器都可以选择进一步定制实例，构造器现在可以访问 self 并修改它的属性，调用实例方法，等等。
- 最终，在链中的任何便利构造器也都可以选择定制实例以及使用 self 。
```

- 构造器的重写
  - Swift的派生类，默认不继承父类的构造器
  - 如果想要派生类有 和父类相同的构造器，需重写，并添加override关键字
  - 派生类可以在构造器件修改变量继承属性，但不能修改常量继承属性
- 自动构造器的继承
  - 前提：派生类引入的所有属性，已经提供默认值
  - 规则一： 若没有定义任何指定构造器，自动继承父类所有指定构造器
  - 规则二： 派生类为父类的所有指定构造器提供了默认实现（包括规则一），自动继承父类所有的遍历构造器
- 可失败构造器 init？
  - 你不能使用相同的参数类型或参数名定义一个可失败构造器后又定义一个非失败构造器。
  - 可以在 可失败构造器中 return nil 表示触发失败
- 枚举的可失败构造器， 在某个case 中触发构造失败
- 带有原始值枚举的可失败构造器
  - 带有原始值的枚举会自动接收一个可失败构造器 init?(rawValue:)
- 构造失败的传递
  - 以服务可失败构造器，可以横向代理一个同类型中的其他可失败构造器
- 重写可失败构造器
  - 可以重写父类的可失败构造器
  - 可以用派生类的非失败构造器重写父类的可失败构造器，向上代理父类构造器 需强制解包
  - 可以用非失败构造器重写可失败构造器，反过来不行
- init!
  - 定义隐式解包可选类型的实例
  - 可以 init?代理到！，反之亦然
  - 可以使用init!重写init?反之亦然
  - 可以用 init 代理到 init!, 构造失败   会触发断言
- 必要构造器
  - 在构造器前 加  required ,指明每个派生类必须实现此构造器
- 使用 闭包或函数设置默认属性值

```swift
class SomeClass {
    let someProperty: SomeType = {
        // 在闭包中创建一个带有默认值的 someProperty
        // someValue 的类型必须是 SomeType
        return someValue
    }()
}
```

()   表示立即执行，若没有（）表示将该闭包赋值给属性

在闭包中不能调用其他属性，和 self